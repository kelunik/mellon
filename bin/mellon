#!/usr/bin/env php
<?php

use Amp\Loop;
use Kelunik\Mellon\Mellon;
use Kelunik\Mellon\Plugins\Canon;
use Kelunik\Mellon\Plugins\GitHubEvents;

require __DIR__ . "/../vendor/autoload.php";

// It's important to catch SIGINT, so destructors can run and save data
Loop::onSignal(\SIGINT, function () {
    Loop::stop();

    exit(0);
});

Loop::run(function () {
    $mellon = new Mellon(getenv("MELLON_CONNECTION"), array_filter(explode(",", getenv("MELLON_CHANNELS") ?: "")) ?: [], [
        Canon::class,
        GitHubEvents::class,
    ]);

    $mellon->start();
});